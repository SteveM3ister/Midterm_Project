---
title: "United States Home Health Care Analysis"
author: "Yinfeng Zhou"
date: "2020/11/26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(drat)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(magrittr)
library(viridis)
library(lubridate)
library(kableExtra)
library(ggpubr)
library(MASS)
library(VGAM)
library(rstanarm)
library(arm)
library(bayesplot)
library(reshape2)
```

#Introduction

This project is meant to implement certain data analysis on the United States Home Health Care Dataset. The motivation of this analysis is to help understanding what factors contributes to a better home health care in rating, and thus help getting knowledge on how we should improve home health care and what the future direction will be in this field. The dataset used in this report is downloaded from Data.Medicare.Gov.

The dataset includes a number of variables that provides measurements of the quality of the home care services. Among the variables that are directly related to the home care service, there are 6 binary variables and 17 continuous variables. The binary varibales answer those "Yes or No" questions: `Offers Nursing Care Services`, `Offers Physical Therapy Services`, `Offers Occupational Therapy Services`, `Offers Speech Pathology Services`, `Offers Medical Social Services`, `Offers Home Health Aide Services`. The continuous varibales mainly answer those "How often" questions, using the measure percentage as reported. For example, in the variable `How often the home health team began their patients' care in a timely manner`, the number indicates the percentage of the home health team having begun their patients' care in a timely manner.    

The outcome we are interested in is the `Quality of patient care star rating`. Although this variable is collected as a numeric rating from 1 through 5, in increments of 0.5, we can treat it as categorical outcomes with 9 possible outcomes. 

In this report, we are mainly interested in how those continuous variables are correlated with the quality rating, building up a model for prediction and hopefully we can do a causal inference. For convenience, the variables name in this report will be changed as in the Appendix A. The variable name in the plot remains the same as in the dataset.
#Method
##Exploratory Data Analysis

In this section, we will apply EDA(Exploratory Data Analysis) on the dataset and get a sense of certain characteristics of the data. To simplify the the analysis, we will take ceiling of the `Quality of patient care star rating`. For example, 3.5 will be rounded up to 4. Without rounded up, the model fitting will also take too much time (longer than 48 hours using stan_polr).    
First, we want to get a sense of the distribution of the quality rating by type of ownership.

```{r}
#read cleaned dataset
care<-read.csv("care_cleaned.csv",header=TRUE)
#extract subset about quality rating
rating<-care[,c(2,9:34)]
colnames(rating)<-c("State","Type.of.Ownership","Offers.Nursing.Care.Services","Offers.Physical.Therapy.Services",                                                                                     "Offers.Occupational.Therapy.Services" ,                                                                   "Offers.Speech.Pathology.Services" ,                                                                        "Offers.Medical.Social.Services" ,                                                                          "Offers.Home.Health.Aide.Services",                                                                        "Date.Certified"            ,                                                                              "Quality.of.Patient.Care.Star.Rating", "TimelyManner","DrugsTeaching","RiskofFalling","Depression","FluShot","Vaccine","FootCare","Walking","Bed","Bathing","Breathing","Operation","DrugsTaking","HospitalAdmitted","UnplannedCare","SkinIntegrity","TimelyMedication")
rating$Type.of.Ownership%<>%factor()
rating$Quality.of.Patient.Care.Star.Rating%<>%ceiling()%<>%factor()
```

```{r}
##Combine rating 1 and 2 as one, as rating 1 does not have enough number


ggplot(data=rating,aes(x=Quality.of.Patient.Care.Star.Rating))+geom_bar(stat="count",aes(fill=Type.of.Ownership))+geom_vline(aes(xintercept=mean(Quality.of.Patient.Care.Star.Rating)),color="red")

```
Since the observations from the first category is much less than the other categories, the rating 1 and 2 are combined as one category, in order for a better model fitting. 
```{r}
rating$Quality.of.Patient.Care.Star.Rating[which(rating$Quality.of.Patient.Care.Star.Rating==1)]<-2
rating$Quality.of.Patient.Care.Star.Rating%<>%factor()
ggplot(data=rating,aes(x=Quality.of.Patient.Care.Star.Rating))+geom_bar(stat="count",aes(fill=Type.of.Ownership))+geom_vline(aes(xintercept=mean(Quality.of.Patient.Care.Star.Rating)),color="red")
```


There are not much difference we can tell from these plots. We then do the EDA on continuous variables.

```{r}
pp1<-ggplot(data=rating,aes(x=TimelyManner,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp2<-ggplot(data=rating,aes(x=DrugsTeaching,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp3<-ggplot(data=rating,aes(x=RiskofFalling,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp4<-ggplot(data=rating,aes(x=Depression,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp5<-ggplot(data=rating,aes(x=FluShot,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp6<-ggplot(data=rating,aes(x=Vaccine,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp7<-ggplot(data=rating,aes(x=FootCare,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp8<-ggplot(data=rating,aes(x=Walking,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp9<-ggplot(data=rating,aes(x=Bed,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp10<-ggplot(data=rating,aes(x=Bathing,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp11<-ggplot(data=rating,aes(x=Breathing,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp12<-ggplot(data=rating,aes(x=Operation,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")


pp13<-ggplot(data=rating,aes(x=DrugsTaking,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp14<-ggplot(data=rating,aes(x=HospitalAdmitted,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp15<-ggplot(data=rating,aes(x=UnplannedCare,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

pp16<-ggplot(data=rating,aes(x=SkinIntegrity,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")
pp17<-ggplot(data=rating,aes(x=TimelyMedication,y=Quality.of.Patient.Care.Star.Rating))+geom_point(size=0.01)+geom_jitter(size=0.01)+ylab("Rating")

ggarrange(pp1,pp2,pp3,pp4,ncol=2,nrow=2,labels="plot1")
ggarrange(pp5,pp6,pp7,pp8,labels="plot2")
ggarrange(pp9,pp10,pp11,pp12,labels="plot3")
ggarrange(pp13,pp14,pp15,pp16,labels="plot4")

ggarrange(pp17,col=1,"plot5")

```
Some examples of  continuous variables versus `Quality of Patient Care Star Rating` are plotted above. The rest will be put in the Appendix B. In general, for the variables `RiskofFalling`, `DrugsTeaching`, `RiskofFalling`, `Depression`, `FootCare`, the points concentrate on the right side, indicating these services are usually provided with a large percentage. Variables `FluShot` and `Vaccine`, while also show a tendency on a large percentage of service, they also have a larger dispersion towards left. In addition, the dots also have a tendency of concentrating on the upper-right, indicating that there should be some positive correlation between the variables and the ratings.     
Moreover, `Walking`, `Bed`, `Bathing`, `Breathing`, `Operation`, `DrugsTaking` are showing a more obvious positive correlation. The `HospitalAdmitted` and `SkinIntegrity` show negative correlations, which is consistent with what the variables represent.

##Modelling
In this section, we will fit an ordinal categorical logistic model on the dataset. 


The polr() function from MASS package will be used in modelling. The stan_polr() is discarded because it took way more than 48 hours to fit the model under an INTEL i5-9400f cpu. 
```{r}
fitset<-rating[,10:27]
colnames(fitset)[1]<-"Rating"
#m1<-polr(Rating~TimelyManner+DrugsTeaching+RiskofFalling+Depression+FluShot+Vaccine+FootCare+Walking+Bed+Bathing+Breathing+Operation+DrugsTaking+HospitalAdmitted+UnplannedCare+SkinIntegrity+TimelyMedication,data=fitset,Hess=TRUE)
m2<-stan_polr(Rating~TimelyManner+DrugsTeaching+RiskofFalling+Depression+FluShot+Vaccine+FootCare+Walking+Bed+Bathing+Breathing+Operation+DrugsTaking+HospitalAdmitted+UnplannedCare+SkinIntegrity+TimelyMedication,data=fitset,prior=NULL,refresh=0)
#m3<-vglm(ordered(Rating)~TimelyManner+DrugsTeaching+RiskofFalling+Depression+FluShot+Vaccine+FootCare+Walking+Bed+Bathing+Breathing+Operation+DrugsTaking+HospitalAdmitted+UnplannedCare+SkinIntegrity+TimelyMedication,data=fitset,family=cumulative(parallel = TRUE))
# summary(m1)
# summary(m3)
summary(m2,digits=2)
```


```{r}
# summary(m3)[1]%>%data.frame()->a
# interval<-data.frame("predictors"=rownames(a),"estimate"=a[,1],"left"=a[,1]-2*a[,2],"right"=a[,1]+2*a[,2])
# ggplot(aes(x = predictors, y = estimate,
#            ymin =left, ymax = right),
#        data = interval[1:17,]) + geom_pointrange(size=0.2) +
#     labs(x= "Predictors",
#          y = "95% Confidece Interval of Coefficient Estiamtes")+
#   theme(axis.text.x = element_text( family = "myFont" ,angle = 60))


interval<-posterior_interval(m2)
interval<-data.frame(name=rownames(interval),interval)
ggplot(aes(x = name, y=(X5.+X95.)/2,
           ymin =X5., ymax = X95.),
       data = interval[1:17,]) + geom_pointrange(size=0.2) +
    labs(x= "Predictors",
         y = "95% Confidece Interval of Coefficient Estiamtes")+
  theme(axis.text.x = element_text( family = "myFont" ,angle = 60))


```
From the coefficent plot, we can extract some useful information. First, the `SkinIntegrity` have a large standard error, indicating that there is a large uncertainty in the estimate. Several coefficients, such as `Depression`, `Flushot`,`Vaccine`,`Operation`,`UnplannedCare`,`SkinIntegrity`,`TimelyMedication` have 95% confidence interval crossing 0, indicating that we can not safely reject that these coefficients should be 0. The result is also consistent with what we found in the EDA, where under these predictors, the `Rating` doesn't show a noticable positive or negative correlation.

##Validation
```{r}
predy<-posterior_predict(m2)
n_sims<-nrow(predy)
subset<-sample(n_sims,100)
yrep<-as.data.frame(lapply(data.frame(predy[subset,]),as.numeric))
```

```{r}
ppc_dens_overlay(as.numeric(temp$Rating)+1,as.matrix(yrep))
ppc_bars(as.numeric(temp$Rating)+1,as.matrix(yrep))
```

The outcome `Rating` is categorical, but I still transform it as numeric and made a `ppc_dens_overlay` to see how well the model fits. In the ppc bar plot, the darker blue dots indicate the medians of `yrep`, and the intervals indicates the uncertainty intervals. Both plots clearly tell us that the model fits quite well.




#Appendix A

`Rating`: Quality of patient care star rating, a numeric rating from 1 through 5, in increments of 0.5. Factored in this report.

`TimelyManner` : How often the home health team began their patients' care in a timely manner.

`DrugsTeaching`: How often the home health team taught patients (or their family caregivers) about their drugs

`RiskofFalling`: How often the home health team checked patients' risk of falling

`Depression`: How often the home health team checked patients for depression

`FluShot`: How often the home health team determined whether patients received a flu shot for the current flu season

`Vaccine`: How often the home health team made sure that their patients have received a pneumococcal vaccine (pneumonia shot)

`FootCare`: With diabetes, how often the home health team got doctor's orders, gave foot care, and taught patients about foot care

`Walking`: How often patients got better at walking or moving around

`Bed`: How often patients got better at getting in and out of bed

`Bathing`: How often patients got better at bathing

`Breathing`: How often patients' breathing improved

`Operation`: How often patients' wounds improved or healed after an operation

`DrugsTaking`: How often patients got better at taking their drugs correctly by mouth

`HospitalAdmitted`: How often home health patients had to be admitted to the hospital

`UnplannedCare`: How often patients receiving home health care needed urgent, unplanned care in the ER without being admitted

`SkinIntegrity`: Changes in skin integrity post-acute care: pressure ulcer/injury

`TimelyMedication`: How often physician-recommended actions to address medication issues were completely timely






